---
title: "Vitc"
output: html_document
date: "2022-12-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = FALSE)
```


```{r lib, message=FALSE}
library(ggplot2)
library(tidyverse)
library(dplyr)
library(interactions)
library(jtools)
library(MuMIn)
```

```{r load_data}
jakob = "C:/Users/pertl/Desktop/Studium Mathematik/7. Barcelona/Linear and Generalized Models/Practical Exercise/VitCGroup7.csv"
ema = "C:/Users/emaca/OneDrive/Documents/INSA/4A/Linear and Generalized Linear Models/Assignment/VitCGroup7.csv"

df = read.csv2(ema)
df$pred = log(df$VitaminaC)
rm(jakob,ema)
```

**1)** REDAC Outcome : Concentration of vitamin C in the orange juice

Predictors : 
- Conservation method (column "Tractament" : a, b or c) which is a categorical variable
- Week of measurement (column "Setmana" from 1 to 12) 

**2)** The data is very evenly spread out, with each week containing 6 observations and each treatment containing 24 observations. Generally we can see that Vitamin C concentration varies a lot. For example the maximum is 5 times the minimum value. Also the interquartile range is 17.22 which is quite high considering the magnitude of values involved.
```{r sum}
summary(df$VitaminaC)
```

A plot of the data shows that there seems to be a decrease VitC concentration over time. Treatment A and B appear to yield very similar results, while treatment C seems to yield higher VitC concentrations.
- The vitamin C concentration with treatment a and b decreases linearly as the weeks pass by 
- Treatment c seems to maintain a higher concentration than a and b after the 4th week 
```{r plt_data}
#simple point plot of data
ggplot(data = df) +
  aes(x = Setmana, y = VitaminaC, color = Tractament) +
    geom_point()
```

The correlation between the Vitamin C concentration and the time in weeks is a strong negative correlation at -0.86. This confirms our eyeballed observation earlier.
```{r cor}
# Correlation between Vitamin and Week
cor(x = df$VitaminaC, y = df$Setmana)
```
**3)** REDAC Is any treatment significantly better than the others in terms of VitC concentration?
Does the Vitamin C concentration differ at packaging for different treatments?
By how much does Vitamin C concentration decrease per week?


**4)** To answer this question, we fit a linear model to the data. As we assume the VitC concentration to be equal at the time of packaging but we are still interested in the effect of the treatment we fit the model with an interaction term but exclude the treatment itself. In mathematical terms this means that we have different $\beta$ for each treatment but our $\alpha$ is the same.
$$
VitaminC_i = \alpha e^{\beta_i .week}
$$
With $i \in \{a,b,c\}$ for each treatment.

```{r 4.1}
mod1 = lm( pred ~ Setmana * Tractament -Tractament, data = df)
summary(mod1)
```
We can see that the time and the treatment c appear to have a significant effect on the Vitamin C concentration. Let us check that our intercept is actually the same for each treatment. We do this by predicting 3 observations each with week being zero and one for each treatment.
```{r}
pr.df = data.frame(Setmana = c(0,0,0), Tractament = c("a", "b", "c"))
predict(mod1, pr.df)
```
Not let us plot our model so that we can get an understanding of what it looks like:
```{r}
interact_plot(mod1, pred = Setmana, modx = Tractament, plot.points = T)
```
In this model we find that $\alpha = 47.61488$ and $\beta[a,b,c] = [-0.1423, -0.1455, -0.0752]$. The betas are best interpreted if we take the exponential of them and we get: $e^{\beta[a,b,c]} = [0.8674, 0.8646, 0.9276]$. These are the factors we will multiply our VitC Concentration with each week. For example lets consider treatment a: each week the concentration will fall by $1-e^{\beta[a]} = 13.26\%$.

\
Finally let us check whether the betas are significantly diferent from eachother. We can do this by checking the anova table.

```{r}
anova(mod1)
```

We see that the interaction "Setmana:Tractament" is highly significant. This indicates that the betas are indeed different from eachother.

**5)** We want to fit a model that does not assume that the treatments have the same Vitamin C concentration at the time of packaging. Thus a linear model that for each slope has a different slope and intercept.
$$
VitaminC_i = \alpha_i e^{\beta_i .week}
$$
With $i \in \{a,b,c\}$ for each treatment.
```{r}
mod2 = lm( pred ~ Setmana * Tractament, data = df)
summary(mod2)
```
We can see in the summary that most values are significant at $\alpha = 0.05$ except for the treatment C. For week zero we would predict the following levels of Vitamin C concentration for different treatments.
```{r}
A = mod2[["coefficients"]][["(Intercept)"]]
B = A + mod2[["coefficients"]][["Tractamentb"]]
C = A + mod2[["coefficients"]][["Tractamentc"]]
A = exp(A)
B = exp(B)
C = exp(C)
cbind(A,B,C)
```

Now let us have a look at a plot that shows our fitted model for each treatment

```{r}
interact_plot(mod2, pred = Setmana, modx = Tractament, plot.points = T)
```

Lastly we want to check whether there is evidence to claim that the treatments have different concentrations of Vitamin C at the time of packaging. We do this by that by assuming the anova method:
```{r}
anova(mod2)
```
We can clearly see that the variable Tractament is highly significant. This indicates that indeed that different treatments lead to a different concentration of VitC at the time of packaging.


**6)** We can choose the best linear model by comparing the Akaike Information Criterion (AIC). We use the function "dredge" from the package "MuMIn" to rank all the possible models by their AIC
```{r}
options(na.action="na.fail")
all_lm <- lm(pred ~ Setmana + Tractament, data = df)
dredge(all_lm,rank = "AIC")
```
We choose the model with the lowest AIC ie.the model considering that the concentration of vitamin C depends both on the week of measurement and on the treatment. It's AIC is equal to -35.0.

```{r}
bmod = lm(pred ~ Setmana + Tractament,data=df)
```

We check if the assumptions of regression (linearity, independence of errors, normality of errors and homoscedasticity) are satisfied with a residual analysis.


```{r}
#Residual analysis for linearity

#Standard residual
plot(rstandard(bmod))
abline(h=c(-2,0,2),lty=2)
```
```{r}
#Studentized residual
plot(rstudent(bmod))
abline(h=c(-2,0,2),lty=2)
```
We see that both residuals plots leads to the conclusion that all the assumptions are satisfied :
- Most of the residuals are in of the interval [-2,2] (only 4 residuals are out) which confirms the assumptions of linearity, normality of errors and homoscedasticity are satisfied.
- We don't see any particular pattern for both plots so we consider that the independence of errors assumption is satisfied.


```{r}
#Adjusted R^2
summary(bmod)
```
The adjusted R-squared is equal to  0.868, it means that the model explains 86.8% of the fluctuation in Vitamin C, which is a sufficient proportion. The residual standard error being low (equal to 0.1822)g which means that the values of the residuals are pretty close to each other. Moreover, the null hypothesis of the omnibus test is clearly rejected (p-value < 0.05), our "best model" have a way better fit to the data than the null model because the explanatory variables play a huge role in the variability of the vitamin C.



**7)**